const { SerialPort } = require('serialport');
const { ReadlineParser } = require('@serialport/parser-readline');

async function initScanners(gates, onScan) {
  console.log('ğŸ” Äang quÃ©t Zebra Scanner...\n');
  
  try {
    const ports = await SerialPort.list();
    
    const zebraPorts = ports.filter(p => 
      p.vendorId?.toLowerCase() === '05e0'
    );
    
    if (zebraPorts.length === 0) {
      console.error('âŒ KHÃ”NG TÃŒM THáº¤Y Zebra Scanner!');
      return;
    }
    
    console.log(`âœ… TÃ¬m tháº¥y ${zebraPorts.length} Zebra Scanner:\n`);
    zebraPorts.forEach((p, i) => {
      console.log(`   ${i + 1}. ${p.path} - locationId: ${p.locationId}`);
    });
    console.log('');
    
    let connectedCount = 0;
    
    for (const [gateKey, gate] of Object.entries(gates)) {
      // â­ TÃŒM THEO locationId (cá»‘ Ä‘á»‹nh vÄ©nh viá»…n)
      const portInfo = zebraPorts.find(p => 
        p.locationId === gate.locationId
      );
      
      if (!portInfo) {
        console.error(`âŒ KhÃ´ng tÃ¬m tháº¥y scanner cho ${gate.name}`);
        console.error(`   Cáº§n locationId: ${gate.locationId}`);
        console.log(`   CÃ³ sáºµn:`);
        zebraPorts.forEach(p => {
          console.log(`      - ${p.path}: ${p.locationId}`);
        });
        console.log('');
        continue;
      }
      
      const port = new SerialPort({
        path: portInfo.path,
        baudRate: 9600,
        autoOpen: true
      });
      
      const parser = port.pipe(
        new ReadlineParser({ delimiter: '\r\n' })
      );
      
      parser.on('data', data => {
        const qrData = data.trim();
        if (!qrData) return;
        
        onScan({
          gateKey,
          gateName: gate.name,
          qrData,
          apikey: gate.apikey,
          inbio: gate.inbio
        });
      });
      
      port.on('open', () => {
        connectedCount++;
        console.log(`âœ… ${gate.name} connected`);
        console.log(`   â””â”€ COM: ${portInfo.path} (auto-detected)`);
        console.log(`   â””â”€ Location: ${gate.locationId}\n`);
      });
      
      port.on('error', err => {
        console.error(`âŒ Lá»—i ${gate.name}:`, err.message);
      });
    }
    
    setTimeout(() => {
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log(`ğŸ“Š ${connectedCount}/${Object.keys(gates).length} scanner káº¿t ná»‘i`);
      if (connectedCount === Object.keys(gates).length) {
        console.log('ğŸ‰ Táº¥t cáº£ scanner Ä‘Ã£ sáºµn sÃ ng!');
      } else {
        console.log('âš ï¸  Kiá»ƒm tra láº¡i cáº¥u hÃ¬nh locationId!');
      }
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    }, 1000);
    
  } catch (error) {
    console.error('âŒ Lá»—i khá»Ÿi táº¡o scanner:', error.message);
  }
}

module.exports = { initScanners };