<!DOCTYPE html>
<html>
<head>
  <title>Dashboard - QR Access Control</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
      min-height: 100vh;
      color: white;
      overflow-x: hidden;
      transition: background 0.5s ease;
    }
    
    body.bg-green {
      background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
    }
    
    body.bg-purple {
      background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 50%, #a78bfa 100%);
    }
    
    body.bg-blue {
      background: linear-gradient(135deg, #0891b2 0%, #06b6d4 50%, #22d3ee 100%);
    }
    
    body.bg-yellow {
      background: linear-gradient(135deg, #d97706 0%, #f59e0b 50%, #fbbf24 100%);
    }
    
    body.bg-red {
      background: linear-gradient(135deg, #e01010 0%, #da1212 50%, #d81111 100%);
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 3px solid rgba(255,255,255,0.2);
      margin-bottom: 30px;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo-img {
      width: 250px;
      height: 250px;
      object-fit: contain;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      padding: 6px;
    }

    .org-name {
      font-size: 3em;
      font-weight: 700;
      color: #fde68a;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
    }
    
    .header-right {
      text-align: right;
    }
    
    .user-info {
      background: rgba(255,255,255,0.2);
      padding: 15px 25px;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .user-info:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    
    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: #b91c1c;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    
    .main-content {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: calc(100vh - 400px);
    }
    
    .main-display {
      width: 100%;
      max-width: 95%;
      padding: 60px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 2px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .status-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      animation: slideDown 0.4s ease;
    }

    .status-message {
      font-size: clamp(4rem, 8vw, 7rem);
      font-weight: 900;
      text-align: center;
      line-height: 1.2;
    }
    
    .success {
      color: #f8f8f8ff;
      text-shadow: 0 0 30px rgba(16, 185, 129, 0.5);
    }
    
    .denied {
      color: #f8f8f8ff;
      text-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
    }
    
    .waiting {
      color: #fbbf24;
      text-shadow: 0 0 30px rgba(251, 191, 36, 0.5);
    }
    
    .scan-info {
      background: rgba(255,255,255,0.15);
      border-radius: 15px;
      margin-top: 20px;
      padding: 60px 80px 120px 80px;
      width: 100%;
      max-width: 100%;
      position: relative;
    }

    .info-row {
      display: flex;
      padding: 25px 0;
      justify-content: center;
      align-items: center;
    }

    .info-value {
      width: 100%;
      text-align: center;
      font-size: clamp(3.5rem, 6vw, 6rem);
      font-weight: 600;
      line-height: 1.4;
    }

    /* Styling cho 4 fields (th√†nh c√¥ng) */
    .scan-info:not(.error-info) .info-row:first-child .info-value {
      font-size: clamp(4rem, 7vw, 7rem);
      font-weight: 800;
      color: #ffffff;
    }

    .scan-info:not(.error-info) .info-row:last-child {
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .scan-info:not(.error-info) .info-row:nth-child(3) .info-value {
      color: #100db4;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .scan-info:not(.error-info) .info-row:nth-child(4) .info-value {
      color: #e6be1f;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* CSS ri√™ng cho error (2 fields - th·∫•t b·∫°i) */
    .scan-info.error-info {
      padding: 80px 80px 80px 80px;
    }

    .scan-info.error-info .info-row {
      padding: 50px 0;
    }

    .scan-info.error-info .info-row .info-value {
      font-size: clamp(3.5rem, 7vw, 7rem);
      font-weight: 700;
      color: #ffffff;
    }

    .scan-info.error-info .info-row:nth-child(2) .info-value {
      color: #e6be1f;
    }

    .scan-info.error-info .info-row:last-child {
      border-top: none;
    }

    /* Total badge */
    .total-badge {
      position: absolute;
      bottom: 20px;
      right: 25px;
      background: #06b6d4;
      color: white;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      font-size: 5em;
      font-weight: 700;
      width: 150px;
      height: 150px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 30px rgba(6, 182, 212, 0.5), 0 0 15px rgba(6, 182, 212, 0.3);
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    /* History Modal Styles */
    .history-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }
    
    .history-modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .history-panel {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      border: 2px solid rgba(255,255,255,0.3);
      max-width: 800px;
      width: 90%;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      animation: slideUp 0.4s ease;
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }
    
    .history-header h3 {
      font-size: 1.8em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-btn {
      background: rgba(239, 68, 68, 0.8);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    .close-btn:hover {
      background: rgba(239, 68, 68, 1);
      transform: scale(1.05);
    }
    
    .date-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .date-filter input {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 12px;
      border-radius: 6px;
      color: white;
      font-size: 0.9em;
    }
    
    .date-filter input::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }
    
    .filter-btn {
      background: rgba(16, 185, 129, 0.8);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .filter-btn:hover {
      background: rgba(16, 185, 129, 1);
      transform: scale(1.05);
    }
    
    .reset-btn {
      background: rgba(251, 191, 36, 0.8);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .reset-btn:hover {
      background: rgba(251, 191, 36, 1);
      transform: scale(1.05);
    }
    
    .history-content {
      overflow-y: auto;
      flex: 1;
    }
    
    .history-item {
      background: rgba(255,255,255,0.2);
      padding: 18px;
      margin-bottom: 12px;
      border-radius: 12px;
      font-size: 0.95em;
      transition: all 0.3s;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .history-item:hover {
      background: rgba(255,255,255,0.25);
      transform: translateX(5px);
    }
    
    .history-item .time {
      opacity: 0.8;
      font-size: 0.9em;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .history-item .name {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 1.1em;
    }
    
    .badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: bold;
      margin-top: 8px;
    }
    
    .reason-display {
      margin-top: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      font-style: italic;
    }
    
    .reason-display.empty {
      color: #fbbf24;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .reason-display.empty:hover {
      background: rgba(251, 191, 36, 0.2);
      transform: scale(1.02);
    }
    
    .reason-input-group {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }
    
    .reason-input {
      flex: 1;
      background: rgba(255,255,255,0.3);
      border: 1px solid rgba(255,255,255,0.4);
      padding: 8px;
      border-radius: 6px;
      color: white;
      font-size: 0.9em;
    }
    
    .reason-input::placeholder {
      color: rgba(255,255,255,0.6);
    }
    
    .save-reason-btn {
      background: rgba(16, 185, 129, 0.8);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .save-reason-btn:hover {
      background: rgba(16, 185, 129, 1);
    }
    
    .cancel-reason-btn {
      background: rgba(239, 68, 68, 0.8);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .cancel-reason-btn:hover {
      background: rgba(239, 68, 68, 1);
    }
    
    .waiting-screen {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 50vh;
    }

    .waiting .status-message {
      font-size: clamp(3rem, 6vw, 5rem);
    }
    
    .scanner-icon {
     font-size: 220px;
      animation: pulse 2s infinite;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideDown {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    ::-webkit-scrollbar {
      width: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.4);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.6);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <img src="/assets/images/AVATAR-01.jpg" alt="Logo" class="logo-img">
        <h1 class="org-name">BAN QU·∫¢N L√ù C·∫¢NG T·ªàNH QU·∫¢NG NG√ÉI</h1>
      </div>
      <div class="header-right">
        <div class="user-info" onclick="toggleHistoryModal()" title="Click ƒë·ªÉ xem l·ªãch s·ª≠">
          üë§ <strong id="staffName">Loading...</strong><br>
          <span style="opacity: 0.8;" id="staffPosition"></span>
        </div>
        <div class="user-info" style="background: rgba(255,255,255,0.15);">
          ‚è∞ <span id="currentTime"></span>
        </div>
        <button class="logout-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
    
    <div class="main-content">
      <div class="main-display" id="mainDisplay">
        <div class="waiting-screen">
          <div class="scanner-icon">üì±</div>
          <h2 class="status-message waiting">Ch·ªù qu√©t QR Code...</h2>
          <p style="font-size: 1.5em; opacity: 0.8;">Vui l√≤ng ƒë∆∞a QR Code ƒë·∫øn m√°y qu√©t Zebra</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- History Modal -->
  <div class="history-modal" id="historyModal" onclick="closeHistoryModal(event)">
    <div class="history-panel" onclick="event.stopPropagation()">
      <div class="history-header">
        <h3>üìã L·ªãch s·ª≠ qu√©t QR</h3>
        <button class="close-btn" onclick="toggleHistoryModal()">‚úï ƒê√≥ng</button>
      </div>
      
      <div class="date-filter">
        <input type="date" id="startDate" placeholder="T·ª´ ng√†y">
        <input type="date" id="endDate" placeholder="ƒê·∫øn ng√†y">
        <button class="filter-btn" onclick="applyDateFilter()">üîç L·ªçc</button>
        <button class="reset-btn" onclick="resetDateFilter()">üîÑ Xem t·∫•t c·∫£</button>
      </div>
      
      <div class="history-content" id="historyContent">
        <div id="historyList">
          <p style="opacity: 0.6; text-align: center; padding: 20px;">Ch∆∞a c√≥ l·ªãch s·ª≠</p>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let currentEditingId = null;
    let eventSource = null;
    let displayTimeout = null;
    
    // ============================================
    // üì° SSE - Real-time Connection
    // ============================================
    function connectSSE() {
      if (eventSource) {
        eventSource.close();
      }
      
      eventSource = new EventSource('/api/scan-stream');
      
      eventSource.onopen = () => {
        console.log('‚úÖ SSE Connected');
        updateConnectionStatus(true);
      };
      
      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          if (data.event === 'newScan' && data.data) {
            console.log('üì• New scan received:', data.data);
            handleNewScan(data.data);
          }
        } catch (error) {
          console.error('‚ùå SSE Parse Error:', error);
        }
      };
      
      eventSource.onerror = () => {
        console.error('‚ùå SSE Connection Error');
        updateConnectionStatus(false);
        
        setTimeout(connectSSE, 5000);
      };
    }
    
    function updateConnectionStatus(isConnected) {
      const indicator = document.getElementById('statusIndicator');
      const text = document.getElementById('statusText');
      
      if (isConnected) {
        indicator.classList.remove('disconnected');
        text.textContent = 'ƒê√£ k·∫øt n·ªëi';
      } else {
        indicator.classList.add('disconnected');
        text.textContent = 'M·∫•t k·∫øt n·ªëi';
      }
    }
    
    // ============================================
    // Handle New Scan
    // ============================================
    function handleNewScan(scan) {
      if (displayTimeout) {
        clearTimeout(displayTimeout);
      }
      
      displayScanResult(scan);
      
      displayTimeout = setTimeout(() => {
        showWaitingScreen();
      }, 10000);
    }
    
    // ============================================
    // Display Functions
    // ============================================
    function displayScanResult(scan) {
        if (!scan) return;

        document.querySelector('.header').style.display = 'none';
        
        const body = document.body;
        body.className = '';
        
        const serverResponse = scan.serverResponse;
        const isSuccess = serverResponse && serverResponse.alert === 'thanhcong';
        
        // X·ª≠ l√Ω background color
        if (serverResponse && serverResponse.background) {
          switch(serverResponse.background.toLowerCase()) {
            case 'green': body.classList.add('bg-green'); break;
            case 'purple': body.classList.add('bg-purple'); break;
            case 'blue': body.classList.add('bg-blue'); break;
            case 'yellow': body.classList.add('bg-yellow'); break;
            case 'red': body.classList.add('bg-red'); break;
          }
        } else if (!isSuccess) {
          body.classList.add('bg-red');
        }
        
        // Hi·ªÉn th·ªã theo format chu·∫©n
        let html = '';
        
        if (isSuccess) {
          html = `
            <div class="status-header success">
              <div class="status-message success">TH√îNG TIN V√â H·ª¢P L·ªÜ, M·ªúI QU√ù KH√ÅCH QUA</div>
            </div>
            <div class="scan-info">
              <div class="info-row">
                <span class="info-value">${serverResponse.text_1 || ''}</span>
              </div>
              <div class="info-row">
                <span class="info-value">${serverResponse.text_2 || ''}</span>
              </div>
              <div class="info-row">
                <span class="info-value">${serverResponse.text_3 || ''}</span>
              </div>
              <div class="info-row">
                <span class="info-value">${serverResponse.text_4 || ''}</span>
              </div>
              ${serverResponse.total !== undefined ? `
                <div class="total-badge">${serverResponse.total}</div>
              ` : ''}
            </div>
          `;
        } else if (serverResponse) {
          html = `
            <div class="status-header denied">
              <div class="status-message denied">TH√îNG TIN V√â KH√îNG H·ª¢P L·ªÜ</div>
            </div>
            <div class="scan-info error-info">
              <div class="info-row">
                <span class="info-value">${serverResponse.text_1 || ''}</span>
              </div>
              <div class="info-row">
                <span class="info-value">${serverResponse.text_2 || ''}</span>
              </div>
            </div>
          `;
        } else {
          // L·ªñI K·∫æT N·ªêI
          html = `
            <div class="status-header denied">
              <div class="status-message denied">L·ªñI K·∫æT N·ªêI</div>
            </div>
            <div class="scan-info error-info">
              <div class="info-row">
                <span class="info-value">${scan.citizenId}</span>
              </div>
              <div class="info-row">
                <span class="info-value">‚ö†Ô∏è Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server</span>
              </div>
            </div>
          `;
        }
        
        document.getElementById('mainDisplay').innerHTML = html;
      }
    
    function showWaitingScreen() {
      document.querySelector('.header').style.display = 'flex';
      document.body.className = '';
      
      document.getElementById('mainDisplay').innerHTML = `
        <div class="waiting-screen">
          <div class="scanner-icon">üì±</div>
          <h2 class="status-message waiting">Ch·ªù qu√©t QR Code...</h2>
          <p style="font-size: 1.5em; opacity: 0.8;">Vui l√≤ng ƒë∆∞a QR Code ƒë·∫øn m√°y qu√©t Zebra</p>
        </div>
      `;
    }
    
    // ============================================
    // ‚è∞ Time Update
    // ============================================
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = 
        now.toLocaleString('vi-VN', { 
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
    }
    updateTime();
    setInterval(updateTime, 1000);
    
    // ============================================
    // üìã History Modal
    // ============================================
    function toggleHistoryModal() {
      const modal = document.getElementById('historyModal');
      modal.classList.toggle('active');
      if (modal.classList.contains('active')) {
        loadHistory();
      }
    }
    
    function closeHistoryModal(event) {
      if (event.target === event.currentTarget) {
        toggleHistoryModal();
      }
    }
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('historyModal');
        if (modal.classList.contains('active')) {
          toggleHistoryModal();
        }
      }
    });
    
    async function applyDateFilter() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      if (!startDate && !endDate) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ng√†y');
        return;
      }
      
      await loadHistory(startDate, endDate);
    }
    
    async function resetDateFilter() {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      await loadHistory();
    }
    
    async function loadHistory(startDate = null, endDate = null) {
      try {
        let url = '/api/staff-history';
        if (startDate || endDate) {
          const params = new URLSearchParams();
          if (startDate) params.append('startDate', startDate);
          if (endDate) params.append('endDate', endDate);
          url += '?' + params.toString();
        }
        
        const response = await fetch(url);
        const data = await response.json();
        displayHistory(data.history);
      } catch (error) {
        console.error('Error loading history:', error);
      }
    }
    
    function displayHistory(history) {
      if (!history || history.length === 0) {
        document.getElementById('historyList').innerHTML = 
          '<p style="opacity: 0.6; text-align: center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
        return;
      }
      
      const historyHtml = history.map(item => {
        const time = new Date(item.timestamp).toLocaleTimeString('vi-VN');
        const date = new Date(item.timestamp).toLocaleDateString('vi-VN');
        const typeColor = item.scanType === 'ƒêƒÉng nh·∫≠p' ? '#10b981' : '#f59e0b';
        const hasReason = item.note && item.note.trim() !== '';
        
        return `
          <div class="history-item" id="item-${item.id}">
            <div class="time">üïê ${date} ${time}</div>
            <div class="name">üë§ ${item.staffName}</div>
            <div style="font-size: 0.9em; opacity: 0.9; margin-top: 5px;">
              üíº ${item.position} | üÜî ${item.staffId}
            </div>
            <div style="margin-top: 8px;">
              <span style="background: ${typeColor}; padding: 5px 15px; border-radius: 20px; font-size: 0.85em; font-weight: bold; color: white;">
                ${item.scanType}
              </span>
            </div>
            ${item.scanType === 'Ch∆∞a r√µ l√Ω do' ? `
              <div class="reason-display ${hasReason ? '' : 'empty'}" 
                   id="reason-display-${item.id}"
                   onclick="${hasReason ? '' : `showReasonInput('${item.id}')`}">
                ${hasReason 
                  ? `üìù L√Ω do: ${item.note}` 
                  : '‚ùó Click ƒë·ªÉ th√™m l√Ω do'}
              </div>
              <div class="reason-input-group" id="reason-input-${item.id}" style="display: none;">
                <input type="text" 
                       class="reason-input" 
                       id="reason-text-${item.id}" 
                       placeholder="Nh·∫≠p l√Ω do qu√©t QR..."
                       value="${item.note || ''}"
                       onkeypress="if(event.key === 'Enter') saveReason('${item.id}')">
                <button class="save-reason-btn" onclick="saveReason('${item.id}')">üíæ L∆∞u</button>
                <button class="cancel-reason-btn" onclick="cancelReasonInput('${item.id}')">‚úï</button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
      
      document.getElementById('historyList').innerHTML = historyHtml;
    }
    
    function showReasonInput(scanId) {
      if (currentEditingId && currentEditingId !== scanId) {
        cancelReasonInput(currentEditingId);
      }
      
      currentEditingId = scanId;
      document.getElementById(`reason-display-${scanId}`).style.display = 'none';
      document.getElementById(`reason-input-${scanId}`).style.display = 'flex';
      document.getElementById(`reason-text-${scanId}`).focus();
    }
    
    function cancelReasonInput(scanId) {
      document.getElementById(`reason-display-${scanId}`).style.display = 'block';
      document.getElementById(`reason-input-${scanId}`).style.display = 'none';
      currentEditingId = null;
    }
    
    async function saveReason(scanId) {
      const reason = document.getElementById(`reason-text-${scanId}`).value.trim();
      
      if (!reason) {
        alert('Vui l√≤ng nh·∫≠p l√Ω do');
        return;
      }
      
      try {
        const response = await fetch('/api/update-scan-reason', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ scanId, reason })
        });
        
        const data = await response.json();
        
        if (data.success) {
          const reasonDisplay = document.getElementById(`reason-display-${scanId}`);
          reasonDisplay.innerHTML = `üìù L√Ω do: ${reason}`;
          reasonDisplay.classList.remove('empty');
          reasonDisplay.onclick = null;
          
          cancelReasonInput(scanId);
          
          alert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t l√Ω do th√†nh c√¥ng');
        } else {
          alert('‚ùå L·ªói: ' + data.message);
        }
      } catch (error) {
        console.error('Error saving reason:', error);
        alert('‚ùå ƒê√£ x·∫£y ra l·ªói khi l∆∞u l√Ω do');
      }
    }
    
    // ============================================
    // üë§ User Management
    // ============================================
    async function loadUserInfo() {
      try {
        const response = await fetch('/api/current-user');
        const data = await response.json();
        
        if (data.user) {
          document.getElementById('staffName').textContent = data.user.staffName;
          document.getElementById('staffPosition').textContent = data.user.position;
        } else {
          window.location.href = '/';
        }
      } catch (error) {
        console.error('Error loading user info:', error);
      }
    }
    
    async function logout() {
      try {
        if (eventSource) {
          eventSource.close();
        }
        await fetch('/api/logout', { method: 'POST' });
        window.location.href = '/';
      } catch (error) {
        console.error('Error logging out:', error);
      }
    }
    
    // ============================================
    // üöÄ Initialize
    // ============================================
    loadUserInfo();
    connectSSE();
    
    // Cleanup khi ƒë√≥ng trang
    window.addEventListener('beforeunload', () => {
      if (eventSource) {
        eventSource.close();
      }
      if (displayTimeout) {
        clearTimeout(displayTimeout);
      }
    });
  </script>
</body>
</html>